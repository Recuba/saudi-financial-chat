---
phase: 01-data-layer-refactor
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - utils/query_router.py
  - app.py
  - components/sidebar.py
autonomous: true

must_haves:
  truths:
    - "Query with 'top' keyword routes to top_bottom_performers view"
    - "Query with 'latest' keyword routes to latest_financials view"
    - "Query with 'sector' + 'compare' routes to sector_benchmarks_latest view"
    - "Query with 'growth' or 'trend' routes to company_annual_timeseries view"
    - "Ambiguous queries default to tasi_financials (full dataset)"
    - "PandasAI receives the routed DataFrame and executes successfully"
    - "No dataset selector visible in sidebar"
  artifacts:
    - path: "utils/query_router.py"
      provides: "Keyword-based query routing to optimal views"
      exports: ["QueryRouter", "route_query"]
    - path: "app.py"
      provides: "Router integration with PandasAI execution"
      contains: "route_query"
    - path: "components/sidebar.py"
      provides: "Simplified sidebar without dataset selector"
  key_links:
    - from: "app.py"
      to: "utils/query_router.py"
      via: "route_query import and call"
      pattern: "route_query\\(.*query"
    - from: "app.py"
      to: "PandasAI DataFrame.chat"
      via: "routed DataFrame passed to pai.DataFrame"
      pattern: "pai\\.DataFrame\\(.*\\)\\.chat"
---

<objective>
Create query router and integrate it with the app to automatically select the optimal data view based on query keywords.

Purpose: Users should not need to understand data structure. Queries are automatically routed to the most efficient view.
Output: New query_router.py module, updated app.py with router integration, updated sidebar.py without dataset selector.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-data-layer-refactor/01-RESEARCH.md

# Prior plan output
@.planning/phases/01-data-layer-refactor/01-01-SUMMARY.md

# Current implementation
@app.py
@components/sidebar.py

# Router pattern reference
@data/files2/tasi_query_helper.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create query_router.py with keyword-based routing</name>
  <files>utils/query_router.py</files>
  <action>
Create new utils/query_router.py with keyword-based query routing:

1. Define KEYWORD_PATTERNS dict mapping intent categories to keyword lists:
   ```python
   KEYWORD_PATTERNS = {
       "ranking": ["top", "bottom", "best", "worst", "highest", "lowest", "rank"],
       "sector": ["sector", "industry", "compare sector", "benchmark"],
       "timeseries": ["growth", "trend", "yoy", "year over year", "change", "over time"],
       "latest": ["latest", "current", "recent", "now", "today", "2024", "2025"],
   }
   ```

2. Define VIEW_MAPPING dict mapping intents to view names:
   ```python
   VIEW_MAPPING = {
       "ranking": "top_bottom_performers",
       "sector": "sector_benchmarks_latest",
       "timeseries": "company_annual_timeseries",
       "latest": "latest_financials",
       "general": "tasi_financials",  # default fallback
   }
   ```

3. Create `route_query(query: str) -> Tuple[str, str]` function:
   - Takes query string
   - Returns (view_name, reason) tuple
   - Check patterns in order: ranking, sector, timeseries, latest
   - Default to "tasi_financials" with reason "General query - using full dataset"

4. Create `QueryRouter` class with:
   - `route(query: str) -> Tuple[str, str]` method
   - Same logic as route_query function
   - Allows future extension (LLM fallback in Phase 2)

5. Add logging for routing decisions:
   `logger.info(f"Routed query to {view_name}: {reason}")`

6. Handle edge cases:
   - Empty query -> default to tasi_financials
   - Query with multiple matching patterns -> prioritize ranking > sector > timeseries > latest
   - Case-insensitive matching

Pattern from research: Use simple keyword matching for Phase 1. LLM fallback added in Phase 2.
  </action>
  <verify>
Run: `python -c "from utils.query_router import route_query; print(route_query('top 10 companies by revenue'))"`
Expected: ('top_bottom_performers', 'Ranking query detected')

Run: `python -c "from utils.query_router import route_query; print(route_query('what is the latest profit for SABIC'))"`
Expected: ('latest_financials', 'Latest data query detected')

Run: `python -c "from utils.query_router import route_query; print(route_query('show me all data'))"`
Expected: ('tasi_financials', 'General query - using full dataset')
  </verify>
  <done>
- route_query() returns (view_name, reason) tuple
- Ranking keywords route to top_bottom_performers
- Sector keywords route to sector_benchmarks_latest
- Growth/trend keywords route to company_annual_timeseries
- Latest keywords route to latest_financials
- Unknown queries default to tasi_financials
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate router in app.py</name>
  <files>app.py</files>
  <action>
Update app.py to use query router instead of sidebar dataset selection:

1. Add import at top:
   `from utils.query_router import route_query`

2. Update data loading section:
   - Change `from utils.data_loader import load_data` to `from utils.data_loader import load_tasi_data`
   - Change `data = load_data()` to `data = load_tasi_data()`

3. Remove sidebar dataset selection:
   - Change `dataset_choice, model_changed = render_sidebar()` to `model_changed = render_sidebar()`
   - Remove `selected_df = data[dataset_choice]`

4. In query processing section (around line 143), add routing before PandasAI:
   ```python
   if prompt:
       # Route query to optimal view
       view_name, route_reason = route_query(prompt)
       selected_df = data[view_name]

       # Show routing info (optional, can be removed later)
       st.caption(f"Using: {view_name}")

       # Existing PandasAI code...
       st.session_state.last_query = prompt
       # ... rest of processing
   ```

5. Update comparison mode section:
   - Comparison mode should use latest_financials or tasi_financials (views with company_name column)
   - Change to: `render_comparison_mode(data["latest_financials"])`

6. Update error handling:
   - Keep existing FileNotFoundError handling
   - Error message should reference tasi_optimized directory

7. Remove references to `dataset_choice` variable throughout

8. Keep advanced_filters working with the routed DataFrame
  </action>
  <verify>
Run app manually: `streamlit run app.py`
- Enter query "top 10 companies by profit"
- Should route to top_bottom_performers and return results
- No dataset selector should appear in sidebar
  </verify>
  <done>
- App loads data from tasi_optimized via load_tasi_data()
- Query routing selects appropriate view before PandasAI
- No manual dataset selection required
- PandasAI receives routed DataFrame
- Comparison mode works with latest_financials
  </done>
</task>

<task type="auto">
  <name>Task 3: Simplify sidebar.py</name>
  <files>components/sidebar.py</files>
  <action>
Update sidebar.py to remove dataset selector and simplify for auto-routing:

1. Remove imports no longer needed:
   - Remove DATASET_DISPLAY_NAMES import
   - Update data_loader import to use new function names

2. Remove functions:
   - Remove `render_dataset_selector()` function entirely
   - Remove `get_dataset_quick_stats()` function (stats now from router)
   - Remove `DATASET_DESCRIPTIONS` dict

3. Update `render_database_info()`:
   - Change to show info from tasi_optimized structure
   - Use load_tasi_data() to get views
   - Show: Total companies (302), Total records (~4748), Views available (7)

4. Update `render_column_reference()`:
   - Remove dataset_name parameter
   - Show columns from tasi_financials (the main view)
   - Group by: identifiers, kpis, ratios, categories (per metadata.json)

5. Update `render_sidebar()` function:
   - Remove dataset_selector call
   - Remove dataset_choice from return value
   - Return only model_changed boolean
   - Update column_reference call (no dataset_name param)

6. Keep these sections working:
   - render_database_info() - show new stats
   - render_model_selector() - unchanged
   - render_llm_status() - unchanged

7. Add optional "View Info" section (collapsed by default):
   - Show which views are available
   - Brief description of each view's purpose
  </action>
  <verify>
Run: `python -c "from components.sidebar import render_sidebar; print('import successful')"`
Expected: "import successful" (no import errors)

Run app and verify:
- No dataset selector visible
- Database info shows correct stats
- Model selector works
- LLM status shows
  </verify>
  <done>
- No dataset selector in sidebar
- Database info shows tasi_optimized stats
- Column reference shows tasi_financials columns
- render_sidebar() returns only model_changed boolean
- Model selector and LLM status unchanged
  </done>
</task>

</tasks>

<verification>
1. Router works correctly:
   ```bash
   python -c "
   from utils.query_router import route_query
   tests = [
       ('top 10 by revenue', 'top_bottom_performers'),
       ('compare sectors', 'sector_benchmarks_latest'),
       ('revenue growth trend', 'company_annual_timeseries'),
       ('latest profit for SABIC', 'latest_financials'),
       ('show all companies', 'tasi_financials'),
   ]
   for query, expected in tests:
       view, _ = route_query(query)
       status = 'PASS' if view == expected else 'FAIL'
       print(f'{status}: {query} -> {view}')
   "
   ```

2. App starts without errors:
   `streamlit run app.py` (should load and show chat interface)

3. No import errors:
   `python -c "from app import *; print('OK')"`

4. End-to-end query test:
   - Start app, enter "what are the top 5 companies by revenue"
   - Should route to top_bottom_performers and return results
</verification>

<success_criteria>
1. route_query() returns correct view for keyword patterns
2. App loads without errors and shows chat interface
3. Queries route to optimal views and PandasAI executes successfully
4. No dataset selector visible in sidebar
5. Query results render correctly (no regression)
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-layer-refactor/01-02-SUMMARY.md`
</output>
