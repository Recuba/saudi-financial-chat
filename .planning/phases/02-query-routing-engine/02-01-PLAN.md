---
phase: 02-query-routing-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - utils/query_router.py
  - tests/test_query_router.py
autonomous: true

must_haves:
  truths:
    - "Query mentioning ticker (e.g., '1010') resolves to company name"
    - "Query mentioning company name (e.g., 'Riyad Bank') is detected"
    - "Additional keyword patterns like 'biggest', 'history', 'quarterly' are recognized"
    - "Unit tests verify entity extraction and keyword matching"
  artifacts:
    - path: "utils/query_router.py"
      provides: "Enhanced QueryRouter with entity extraction"
      contains: "_extract_entities"
    - path: "tests/test_query_router.py"
      provides: "Unit tests for query routing"
      exports: ["test_extract_entities", "test_keyword_patterns"]
  key_links:
    - from: "utils/query_router.py"
      to: "ticker_index DataFrame"
      via: "constructor injection"
      pattern: "ticker_index.*DataFrame"
---

<objective>
Enhance QueryRouter with entity extraction (tickers, company names, sectors) and expanded keyword patterns.

Purpose: Enable queries like "show me 1010 financials" or "Riyad Bank revenue" to resolve company identities, and expand keyword coverage for better routing accuracy (ROUTE-01, ROUTE-04).

Output: Enhanced QueryRouter class with entity extraction capability and comprehensive test suite.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-query-routing-engine/02-RESEARCH.md

@utils/query_router.py
@utils/data_loader.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand keyword patterns and refactor QueryRouter</name>
  <files>utils/query_router.py</files>
  <action>
Enhance the existing QueryRouter with expanded keyword patterns and entity extraction capability.

1. **Expand KEYWORD_PATTERNS** with additional patterns identified in research:
   - ranking: add "biggest", "smallest", "largest", "most", "least", "leader"
   - sector: add "by sector", "per sector", "sector average", "industry average"
   - timeseries: add "history", "historical", "years", "quarterly", "annual"
   - latest: add "last quarter", "most recent", "Q1", "Q2", "Q3", "Q4"

2. **Update QueryRouter class** to accept ticker_index in constructor:
   ```python
   def __init__(self, ticker_index: pd.DataFrame = None, llm_enabled: bool = False):
       self.ticker_index = ticker_index
       self.llm_enabled = llm_enabled
       if ticker_index is not None:
           self._build_lookup_index()
   ```

3. **Add _build_lookup_index() method** to prepare lookup structures:
   - ticker_to_company: dict mapping ticker string to company name
   - company_names: list of lowercase company names for matching
   - name_to_ticker: dict mapping lowercase company name to ticker
   - sectors: list of unique sectors

4. **Add _extract_entities() method** that returns dict with keys:
   - 'tickers': list of matched ticker codes (4-digit numbers found in ticker_index)
   - 'companies': list of matched company names
   - 'sectors': list of detected sector names

   Implementation approach (from research):
   - Use regex `\b(\d{4})\b` to extract 4-digit tickers
   - Use substring matching for company names (case-insensitive)
   - Use difflib.SequenceMatcher for fuzzy matching (threshold 0.6 for names > 5 chars)
   - Handle sector aliases (e.g., "financial" -> "Financials", "bank" -> "Financials")

5. **Update route() method** to call _extract_entities() and include entities in return:
   - Return signature changes from Tuple[str, str] to Tuple[str, str, dict]
   - Third element is entities dict (empty if no ticker_index provided)
   - For now, entities are informational only (routing logic unchanged)

6. **Keep route_query() function** for backward compatibility but have it use QueryRouter internally.

Avoid: Don't add LLM classification yet (that's Plan 02-02). Don't change the routing logic priority order.
  </action>
  <verify>
Run `python -c "from utils.query_router import QueryRouter; print('Import OK')"` - should succeed.
Run `python -c "from utils.query_router import route_query; print(route_query('top 10'))"` - should return tuple.
  </verify>
  <done>
QueryRouter accepts ticker_index parameter, has _extract_entities() method, and includes expanded keyword patterns. Backward compatibility with route_query() maintained.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive tests for query routing</name>
  <files>tests/test_query_router.py</files>
  <action>
Create a new test file for query_router with comprehensive test coverage.

1. **Test keyword pattern matching:**
   - test_ranking_keywords: "top", "bottom", "biggest", "smallest", "rank"
   - test_sector_keywords: "sector", "industry", "by sector"
   - test_timeseries_keywords: "growth", "trend", "history", "years"
   - test_latest_keywords: "latest", "current", "Q1", "Q2"
   - test_fallback_to_general: queries with no keywords

2. **Test priority order:**
   - test_priority_ranking_over_latest: "top 10 latest" -> ranking
   - test_priority_sector_over_timeseries: "sector growth" -> sector

3. **Test entity extraction** (mock ticker_index DataFrame):
   ```python
   @pytest.fixture
   def mock_ticker_index():
       return pd.DataFrame({
           'ticker': ['1010', '1020', '2050'],
           'company_name': ['Riyad Bank', 'Bank Aljazira', 'Savola Group'],
           'sector': ['Financials', 'Financials', 'Other']
       })
   ```

4. **Test entity extraction scenarios:**
   - test_extract_ticker: "show 1010 data" -> tickers=['1010']
   - test_extract_company: "Riyad Bank revenue" -> companies=['Riyad Bank']
   - test_extract_sector: "financials sector" -> sectors=['Financials']
   - test_extract_multiple: "compare 1010 and 1020" -> tickers=['1010', '1020']
   - test_fuzzy_match: "savola" matches "Savola Group"
   - test_no_entities: "show all data" -> empty entities

5. **Test backward compatibility:**
   - test_route_query_function: route_query() returns (str, str) tuple
   - test_router_without_ticker_index: QueryRouter() works without ticker_index

Use pytest conventions. Import from utils.query_router.
  </action>
  <verify>
Run `pytest tests/test_query_router.py -v` - all tests should pass.
  </verify>
  <done>
Test file exists with 15+ test functions covering keywords, priority, entity extraction, and backward compatibility. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update app.py to use enhanced router</name>
  <files>app.py</files>
  <action>
Update app.py to instantiate QueryRouter with ticker_index for entity-aware routing.

1. **Change import:**
   ```python
   from utils.query_router import QueryRouter  # Instead of route_query
   ```

2. **Create router with ticker_index after data is loaded:**
   ```python
   data = load_tasi_data()
   router = QueryRouter(ticker_index=data['ticker_index'])
   ```

3. **Update query processing to use router instance:**
   ```python
   view_name, route_reason, entities = router.route(prompt)
   ```

4. **Enhance routing info display:**
   ```python
   # Show routing info with entity detection
   entity_info = ""
   if entities.get('tickers'):
       entity_info = f" | Detected: {', '.join(entities['tickers'])}"
   elif entities.get('companies'):
       entity_info = f" | Detected: {', '.join(entities['companies'][:2])}"

   st.caption(f"Using: {view_name}{entity_info}")
   ```

Avoid: Don't change other parts of app.py. Keep the same user flow.
  </action>
  <verify>
Run `streamlit run app.py` and query "show 1010 data" - should display "Using: ... | Detected: 1010".
Run `streamlit run app.py` and query "top 10" - should display "Using: top_bottom_performers".
  </verify>
  <done>
app.py uses QueryRouter with ticker_index, displays entity detection info for queries mentioning tickers or companies.
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/test_query_router.py -v` - all tests pass
2. `python -c "from utils.query_router import QueryRouter; r = QueryRouter(); print(r.route('top 10'))"` - returns tuple
3. App runs without errors and shows enhanced routing info
</verification>

<success_criteria>
- QueryRouter._extract_entities() correctly identifies tickers, companies, sectors from queries
- Expanded keyword patterns match more query formulations
- All existing routing behavior preserved (backward compatible)
- Test suite has 15+ tests covering keywords, priority, and entity extraction
- App displays detected entities in routing caption
</success_criteria>

<output>
After completion, create `.planning/phases/02-query-routing-engine/02-01-SUMMARY.md`
</output>
